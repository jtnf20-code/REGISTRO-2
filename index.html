<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Detenidos</title>

  <!-- Fuente Comfortaa -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Librer√≠as desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    body {
      font-family: 'Comfortaa', sans-serif;
      margin: 20px;
      background: #f4f4f9;
      color: #000; /* üëâ Texto fuera del formulario en negro */
    }
    h1 {
      text-align: center;
      text-transform: uppercase;
      color: #000; /* üëâ t√≠tulo en negro */
      font-size: 2.2em;
      margin-bottom: 30px;
    }
    form {
      background: url('fondo.jpg') center/cover no-repeat;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      max-width: 650px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 15px;
      text-transform: uppercase;
      color: #ffffff;
      font-size: 1.1em;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px; /* üëâ igual tama√±o de globos */
      margin-top: 6px;
      font-family: 'Comfortaa', sans-serif;
      border: 2px solid #ffffff80;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.95);
      font-size: 15px;
      color: #000;
      box-sizing: border-box; /* üëâ todos consistentes */
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
    }
    textarea {
      resize: vertical; /* ajustable verticalmente */
      min-height: 100px; /* üëâ mantiene tama√±o consistente */
    }
    button {
      margin-top: 25px;
      padding: 14px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-family: 'Comfortaa', sans-serif;
      font-weight: 700;
      font-size: 16px;
      text-transform: uppercase;
    }
    button:hover { background: #2980b9; }
    #message {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      white-space: pre-line;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <h1>Registro de Detenidos</h1>
  <form id="registroForm">

    <!-- üîπ Aqu√≠ siguen todos los inputs id√©nticos a tu versi√≥n actual (TIPO DOCUMENTO, SEXO, etc.) -->
    <label>INSTRUCTOR: <input type="text" name="INSTRUCTOR"></label>

    <label>ABOGADO:
      <select name="ABOGADO_OPCION">
        <option value="DE OFICIO" selected>DE OFICIO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="ABOGADO" placeholder="Especificar abogado" style="display:none;">
    </label>

    <label>COMUNICARSE CON:
      <select name="COMUNICARSE CON_OPCION">
        <option value="nadie" selected>nadie</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="COMUNICARSE CON" placeholder="Especificar contacto" style="display:none;">
    </label>

    <label>M√âDICO:
      <select name="MEDICO">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </label>

    <label>CONSULADO:
      <select name="CONSULADO">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </label>

    <button type="submit">Generar ZIP con Excel + ODTs</button>
  </form>

  <div id="message"></div>

  <script>
    // Mostrar/ocultar input si elige "OTRO"
    document.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', function() {
        const textInput = this.closest('label')?.querySelector('input[type="text"]');
        if (textInput) {
          textInput.style.display = (this.value === 'OTRO') ? 'block' : 'none';
          if (this.value !== 'OTRO') textInput.value = '';
        }
      });
    });

    function showMessage(msg) { document.getElementById("message").innerText = msg; }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

    // Funci√≥n para Title Case (cada palabra inicial en may√∫scula)
    function toTitleCase(str) {
      return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    }

    // Regex tolerante a placeholders partidos
    function buildFlexibleRegex(key) {
      const chars = key.split("").map(ch => escapeRegExp(ch));
      const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
      return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*" + flexible + "(?:\\s|<[^>]+>|&nbsp;)*\\}\\}", "gi");
    }

    const ODT_TEMPLATES = {
      amarillas:        { file: "Plantilla_amarillas.odt" },
      azules:           { file: "Plantilla_azules.odt" },
      fax:              { file: "Plantilla_fax.odt" },
      derechos_ingles:  { file: "Plantilla_derechos_ingles.odt" },
      derechos_espanol: { file: "Plantilla_derechos_espanol.odt" }
    };
    // these documents can only be used in code execution

    async function generarODTBlob(data, odtFileName) {
      const resp = await fetch(odtFileName);
      if (!resp.ok) throw new Error("No se pudo cargar " + odtFileName);
      const arrayBuf = await resp.arrayBuffer();
      const odtZip = await JSZip.loadAsync(arrayBuf);
      let contentXml = await odtZip.file("content.xml").async("string");
      if (contentXml.normalize) contentXml = contentXml.normalize("NFC");

      for (const k in data) {
        const valor = data[k] ?? "";
        const regexFlexible = buildFlexibleRegex(k);
        contentXml = contentXml.replace(regexFlexible, valor);
        const reExact = new RegExp(`{{${escapeRegExp(k)}}}`, "g");
        const reSpaces = new RegExp(`{{\\s*${escapeRegExp(k)}\\s*}}`, "g");
        contentXml = contentXml.replace(reExact, valor).replace(reSpaces, valor);
      }
      contentXml = contentXml.replace(/{{\s*[^}]+\s*}}/g, "");
      odtZip.file("content.xml", contentXml);
      return await odtZip.generateAsync({ type: "blob" });
    }

    document.getElementById("registroForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      showMessage("Generando archivos...");

      const formData = new FormData(e.target);
      const data = {};

      // ABOGADO en Title Case
      const abo = formData.get("ABOGADO_OPCION") === "OTRO" ? formData.get("ABOGADO") : formData.get("ABOGADO_OPCION");
      data["ABOGADO"] = abo ? toTitleCase(abo) : "De Oficio";

      // COMUNICARSE CON en Title Case (o Nadie)
      const comSel = formData.get("COMUNICARSE CON_OPCION");
      const comTxt = formData.get("COMUNICARSE CON");
      if (comSel === "OTRO" && comTxt) {
        data["COMUNICARSE CON:"] = toTitleCase(comTxt);
      } else {
        data["COMUNICARSE CON:"] = "Nadie";
      }

      // M√âDICO / CONSULADO
      data["MEDICO"] = (formData.get("MEDICO") === "SI") ? "SI" : "";
      data["CONSULADO"] = (formData.get("CONSULADO") === "SI") ? "SI" : "";

      // Resto de campos en MAY√öSCULAS (como antes)
      formData.forEach((value, key) => {
        if (!key.includes("_OPCION") &&
            !["ABOGADO","COMUNICARSE CON","MEDICO","CONSULADO"].includes(key)) {
          data[key] = (value && value.trim() !== "") ? value.toUpperCase() : "";
        }
      });

      // Excel con headers actualizados
      const headers = [
        "TIPO DOCUMENTO","N¬∫DOCUMENTO","SEXO","Nombre","APELLIDOS","Nombre de los Padres",
        "FECHA DE NACIMIENTO","LUGAR DE NACIMIENTO","NACIONALIDAD","DOMICILIO","TEL√âFONO",
        "DELITO","C.P. AGENTES","DILIGENCIAS","INSTRUCTOR",
        "LUGAR DEL HECHO","LUGAR DE LA DETENCI√ìN",
        "HORA DEL HECHO","HORA DE LA DETENCI√ìN","BREVE RESUMEN DE LOS HECHOS",
        "INDICIOS POR LOS QUE SE DETIENE","ABOGADO","COMUNICARSE CON:","IDIOMA","MEDICO","CONSULADO"
      ];
      const row = {}; headers.forEach(h => row[h] = data[h] || "");
      const ws = XLSX.utils.json_to_sheet([row], { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Registro");
      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const excelBlob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

      // Generar ODTs
      const keys = Object.keys(ODT_TEMPLATES);
      const odtResults = await Promise.all(keys.map(async key => {
        const { file } = ODT_TEMPLATES[key];
        try {
          const blob = await generarODTBlob(data, file);
          const nombre = key + "_" + (data["Nombre"] || "SINNOMBRE") + "_" + (data["APELLIDOS"] || "SINAPELLIDOS") + ".odt";
          return { out: nombre, blob };
        } catch (e) {
          console.error("Error con plantilla", file, e);
          return null;
        }
      }));

      try {
        const z = new JSZip();
        z.file("DETENIDO.xlsx", excelBlob);
        for (const item of odtResults) if (item?.blob) z.file(item.out, item.blob);
        const zipBlob = await z.generateAsync({ type: "blob" });
        saveAs(zipBlob, "DETENIDO.zip");
        showMessage("‚úÖ Archivos generados y empaquetados.");
      } catch (err) {
        console.error("Error creando ZIP", err);
        saveAs(excelBlob, "DETENIDO.xlsx");
        showMessage("‚ùå No se pudo comprimir, solo Excel descargado.");
      }
    });
  </script>
</body>
</html>
