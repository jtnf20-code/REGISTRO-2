<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Detenidos</title>

  <!-- Fuente Comfortaa -->
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Librerías desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    body {
      font-family: 'Comfortaa', sans-serif;
      margin: 20px;
      background: #f4f4f9;
      color: #000 !important; /* Texto fuera del formulario en negro forzado */
    }
    h1, p, #message {
      color: #000 !important; /* Forzamos negro por si hay estilos cacheados */
    }
    h1 {
      text-align: center;
      text-transform: uppercase;
      font-size: 2.2em;
      margin-bottom: 30px;
    }
    form {
      background: url('fondo.jpg') center/cover no-repeat;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
      max-width: 650px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 15px;
      text-transform: uppercase;
      color: #ffffff; /* blanco dentro del formulario para contraste */
      font-size: 1.05em;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px; /* globos homogéneos */
      margin-top: 6px;
      font-family: 'Comfortaa', sans-serif;
      border: 2px solid #ffffff80;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.95);
      font-size: 15px;
      color: #000;
      box-sizing: border-box;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button {
      margin-top: 25px;
      padding: 14px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-family: 'Comfortaa', sans-serif;
      font-weight: 700;
      font-size: 16px;
      text-transform: uppercase;
    }
    button:hover { background: #2980b9; }
    #message {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm">
    <label>TIPO DOCUMENTO:
      <select name="TIPO DOCUMENTO_OPCION">
        <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
        <option value="DNI">DNI</option>
        <option value="NIE">NIE</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="TIPO DOCUMENTO" placeholder="Especificar otro" style="display:none;">
    </label>

    <label>NºDOCUMENTO: <input type="text" name="NºDOCUMENTO"></label>

    <label>SEXO:
      <select name="SEXO_OPCION">
        <option value="MASCULINO" selected>MASCULINO</option>
        <option value="FEMENINO">FEMENINO</option>
      </select>
    </label>

    <label>NOMBRE: <input type="text" name="Nombre"></label>
    <label>APELLIDOS: <input type="text" name="APELLIDOS"></label>
    <label>NOMBRE DE LOS PADRES: <input type="text" name="Nombre de los Padres"></label>

    <label>FECHA DE NACIMIENTO: <input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></label>
    <label>LUGAR DE NACIMIENTO: <input type="text" name="LUGAR DE NACIMIENTO"></label>
    <label>NACIONALIDAD: <input type="text" name="NACIONALIDAD"></label>

    <label>DOMICILIO:
      <select name="DOMICILIO_OPCION">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="DOMICILIO" placeholder="Especificar domicilio" style="display:none;">
    </label>

    <label>TELÉFONO:
      <select name="TELÉFONO_OPCION">
        <option value="NO APORTA" selected>NO APORTA</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="TELÉFONO" placeholder="Especificar teléfono" style="display:none;">
    </label>

    <label>DELITO: <input type="text" name="DELITO"></label>
    <label>C.P. AGENTES: <input type="text" name="C.P. AGENTES"></label>
    <label>DILIGENCIAS: <input type="text" name="DILIGENCIAS"></label>
    <label>INSTRUCTOR: <input type="text" name="INSTRUCTOR"></label>

    <label>LUGAR DEL HECHO: <input type="text" name="LUGAR DEL HECHO"></label>
    <label>LUGAR DE LA DETENCIÓN: <input type="text" name="LUGAR DE LA DETENCIÓN"></label>
    <label>HORA DEL HECHO: <input type="text" name="HORA DEL HECHO" placeholder="HH:MM"></label>
    <label>HORA DE LA DETENCIÓN: <input type="text" name="HORA DE LA DETENCIÓN" placeholder="HH:MM"></label>

    <label>BREVE RESUMEN DE LOS HECHOS:
      <textarea name="BREVE RESUMEN DE LOS HECHOS" rows="3"></textarea>
    </label>
    <label>INDICIOS POR LOS QUE SE DETIENE:
      <textarea name="INDICIOS POR LOS QUE SE DETIENE" rows="3"></textarea>
    </label>

    <label>ABOGADO:
      <select name="ABOGADO_OPCION">
        <option value="DE OFICIO" selected>DE OFICIO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="ABOGADO" placeholder="Especificar abogado" style="display:none;">
    </label>

    <label>COMUNICARSE CON:
      <select name="COMUNICARSE CON_OPCION">
        <option value="nadie" selected>nadie</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="COMUNICARSE CON" placeholder="Especificar contacto" style="display:none;">
    </label>

    <label>INTÉRPRETE:
      <select name="INTERPRETE_OPCION">
        <option value="NO" selected>NO</option>
        <option value="OTRO">OTRO</option>
      </select>
      <input type="text" name="INTERPRETE" placeholder="Especificar idioma" style="display:none;">
    </label>

    <label>MÉDICO:
      <select name="MEDICO">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </label>

    <label>CONSULADO:
      <select name="CONSULADO">
        <option value="NO" selected>NO</option>
        <option value="SI">SI</option>
      </select>
    </label>

    <button type="submit">Generar ZIP con Excel + ODTs</button>
  </form>

  <div id="message"></div>

  <script>
    // Mostrar/ocultar input si elige "OTRO"
    document.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', function() {
        const textInput = this.closest('label')?.querySelector('input[type="text"]');
        if (textInput) {
          textInput.style.display = (this.value === 'OTRO') ? 'block' : 'none';
          if (this.value !== 'OTRO') textInput.value = '';
        }
      });
    });

    function showMessage(msg) { document.getElementById("message").innerText = msg; }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }

    // Title Case
    function toTitleCase(str) {
      return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    }

    // Regex tolerante a placeholders partidos
    function buildFlexibleRegex(key) {
      const chars = key.split("").map(ch => escapeRegExp(ch));
      const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
      return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*" + flexible + "(?:\\s|<[^>]+>|&nbsp;)*\\}\\}", "gi");
    }

    // Plantillas ODT (these documents can only be used in code execution)
    const ODT_TEMPLATES = {
      amarillas:        { file: "Plantilla_amarillas.odt" },
      azules:           { file: "Plantilla_azules.odt" },
      fax:              { file: "Plantilla_fax.odt" },
      derechos_ingles:  { file: "Plantilla_derechos_ingles.odt" },
      derechos_espanol: { file: "Plantilla_derechos_espanol.odt" }
    };

    // Reemplazo tolerante en ODT
    async function generarODTBlob(data, odtFileName) {
      const resp = await fetch(odtFileName);
      if (!resp.ok) throw new Error("No se pudo cargar " + odtFileName);
      const arrayBuf = await resp.arrayBuffer();
      const odtZip = await JSZip.loadAsync(arrayBuf);
      let contentXml = await odtZip.file("content.xml").async("string");
      if (contentXml.normalize) contentXml = contentXml.normalize("NFC");

      for (const k in data) {
        const valor = data[k] ?? "";
        const regexFlexible = buildFlexibleRegex(k);
        contentXml = contentXml.replace(regexFlexible, valor);
        const reExact = new RegExp(`{{${escapeRegExp(k)}}}`, "g");
        const reSpaces = new RegExp(`{{\\s*${escapeRegExp(k)}\\s*}}`, "g");
        contentXml = contentXml.replace(reExact, valor).replace(reSpaces, valor);
      }
      contentXml = contentXml.replace(/{{\s*[^}]+\s*}}/g, "");
      odtZip.file("content.xml", contentXml);
      return await odtZip.generateAsync({ type: "blob" });
    }

    document.getElementById("registroForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      showMessage("Generando archivos...");

      const formData = new FormData(e.target);
      const data = {};

      // TIPO DOCUMENTO
      const tipoDoc = formData.get("TIPO DOCUMENTO_OPCION") === "OTRO" ? formData.get("TIPO DOCUMENTO") : formData.get("TIPO DOCUMENTO_OPCION");
      data["TIPO DOCUMENTO"] = (tipoDoc || "INDOCUMENTADO/A").toUpperCase();

      // SEXO
      data["SEXO"] = (formData.get("SEXO_OPCION") || "MASCULINO").toUpperCase();

      // DOMICILIO
      const domicilio = formData.get("DOMICILIO_OPCION") === "OTRO" ? formData.get("DOMICILIO") : formData.get("DOMICILIO_OPCION");
      data["DOMICILIO"] = (domicilio || "NO APORTA").toUpperCase();

      // TELÉFONO
      const tel = formData.get("TELÉFONO_OPCION") === "OTRO" ? formData.get("TELÉFONO") : formData.get("TELÉFONO_OPCION");
      data["TELÉFONO"] = (tel || "NO APORTA").toUpperCase();

      // ABOGADO (Title Case)
      const abo = formData.get("ABOGADO_OPCION") === "OTRO" ? formData.get("ABOGADO") : formData.get("ABOGADO_OPCION");
      data["ABOGADO"] = abo ? toTitleCase(abo) : "De Oficio";

      // COMUNICARSE CON (Title Case o "Nadie")
      const comSel = formData.get("COMUNICARSE CON_OPCION");
      const comTxt = formData.get("COMUNICARSE CON");
      if (comSel === "OTRO" && comTxt) {
        data["COMUNICARSE CON:"] = toTitleCase(comTxt);
      } else {
        data["COMUNICARSE CON:"] = "Nadie";
      }

      // INTÉRPRETE → {{IDIOMA}}
      const interpreteSel = formData.get("INTERPRETE_OPCION");
      const interpreteOtro = formData.get("INTERPRETE");
      data["IDIOMA"] = (interpreteSel === "OTRO" && interpreteOtro) ? interpreteOtro : "";

      // MÉDICO y CONSULADO → “SI” o vacío
      data["MEDICO"] = (formData.get("MEDICO") === "SI") ? "SI" : "";
      data["CONSULADO"] = (formData.get("CONSULADO") === "SI") ? "SI" : "";

      // Resto de campos → en MAYÚSCULAS o vacío, siempre presentes
      formData.forEach((value, key) => {
        if (!key.includes("_OPCION") &&
            !["ABOGADO","COMUNICARSE CON","MEDICO","CONSULADO","TIPO DOCUMENTO","DOMICILIO","TELÉFONO","INTERPRETE"].includes(key)) {
          data[key] = (value && value.trim() !== "") ? value.toUpperCase() : "";
        }
      });

      // Excel
      const headers = [
        "TIPO DOCUMENTO","NºDOCUMENTO","SEXO","Nombre","APELLIDOS","Nombre de los Padres",
        "FECHA DE NACIMIENTO","LUGAR DE NACIMIENTO","NACIONALIDAD","DOMICILIO","TELÉFONO",
        "DELITO","C.P. AGENTES","DILIGENCIAS","INSTRUCTOR",
        "LUGAR DEL HECHO","LUGAR DE LA DETENCIÓN",
        "HORA DEL HECHO","HORA DE LA DETENCIÓN","BREVE RESUMEN DE LOS HECHOS",
        "INDICIOS POR LOS QUE SE DETIENE","ABOGADO","COMUNICARSE CON:","IDIOMA","MEDICO","CONSULADO"
      ];
      const row = {}; headers.forEach(h => row[h] = data[h] || "");
      const ws = XLSX.utils.json_to_sheet([row], { header: headers });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Registro");
      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const excelBlob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

      // Generar ODTs
      const keys = Object.keys(ODT_TEMPLATES);
      const odtResults = await Promise.all(keys.map(async key => {
        const { file } = ODT_TEMPLATES[key];
        try {
          const blob = await generarODTBlob(data, file);
          const nombre = key + "_" + (data["Nombre"] || "SINNOMBRE") + "_" + (data["APELLIDOS"] || "SINAPELLIDOS") + ".odt";
          return { out: nombre, blob };
        } catch (e) {
          console.error("Error con plantilla", file, e);
          return null;
        }
      }));

      // ZIP
      try {
        const z = new JSZip();
        z.file("DETENIDO.xlsx", excelBlob);
        for (const item of odtResults) if (item?.blob) z.file(item.out, item.blob);
        const zipBlob = await z.generateAsync({ type: "blob" });
        saveAs(zipBlob, "DETENIDO.zip");
        const ok = odtResults.filter(x => x?.blob).length;
        showMessage(`✅ DETENIDO.zip generado (sin cifrar).\nIncluye Excel y ${ok}/${keys.length} ODTs.`);
      } catch (err) {
        console.error("Error creando ZIP", err);
        saveAs(excelBlob, "DETENIDO.xlsx");
        showMessage("❌ No se pudo crear el ZIP. Solo Excel descargado.");
      }
    });
  </script>
</body>
</html>
