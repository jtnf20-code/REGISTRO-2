<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Detenidos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .row {
            display: flex;
            gap: 15px;
        }
        .col {
            flex: 1;
        }
        button {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #219a52;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📋 Registro de Detenidos</h1>
        
        <form id="registroForm">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="tipoDocumento">Tipo Documento:</label>
                        <select id="tipoDocumento" name="TIPO DOCUMENTO" required>
                            <option value="">Seleccionar...</option>
                            <option value="DNI">DNI</option>
                            <option value="NIE">NIE</option>
                            <option value="Pasaporte">Pasaporte</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="numeroDocumento">Nº Documento:</label>
                        <input type="text" id="numeroDocumento" name="NºDOCUMENTO" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="Nombre" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="apellidos">Apellidos:</label>
                        <input type="text" id="apellidos" name="APELLIDOS" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="sexo">Sexo:</label>
                        <select id="sexo" name="SEXO" required>
                            <option value="">Seleccionar...</option>
                            <option value="MASCULINO">Masculino</option>
                            <option value="FEMENINO">Femenino</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="fechaNacimiento">Fecha de Nacimiento:</label>
                        <input type="date" id="fechaNacimiento" name="FECHA DE NACIMIENTO" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="lugarNacimiento">Lugar de Nacimiento:</label>
                        <input type="text" id="lugarNacimiento" name="LUGAR DE NACIMIENTO" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="nacionalidad">Nacionalidad:</label>
                        <input type="text" id="nacionalidad" name="NACIONALIDAD" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="nombrePadres">Nombre de los Padres:</label>
                <input type="text" id="nombrePadres" name="Nombre de los Padres">
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="domicilio">Domicilio:</label>
                        <input type="text" id="domicilio" name="DOMICILIO">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="telefono">Teléfono:</label>
                        <input type="tel" id="telefono" name="TELÉFONO">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="delito">Delito:</label>
                <input type="text" id="delito" name="DELITO" required>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="cpAgentes">C.P. Agentes:</label>
                        <input type="text" id="cpAgentes" name="C.P. AGENTES">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="diligencias">Diligencias:</label>
                        <input type="text" id="diligencias" name="DILIGENCIAS">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="lugarHecho">Lugar del Hecho:</label>
                        <input type="text" id="lugarHecho" name="LUGAR DEL HECHO" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="lugarDetencion">Lugar de la Detención:</label>
                        <input type="text" id="lugarDetencion" name="LUGAR DE LA DETENCIÓN" required>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="horaHecho">Hora del Hecho:</label>
                        <input type="time" id="horaHecho" name="HORA DEL HECHO" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="horaDetencion">Hora de la Detención:</label>
                        <input type="time" id="horaDetencion" name="HORA DE LA DETENCIÓN" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="breveResumen">Breve Resumen de los Hechos:</label>
                <textarea id="breveResumen" name="BREVE RESUMEN DE LOS HECHOS" required></textarea>
            </div>

            <div class="form-group">
                <label for="indicios">Indicios por los que se Detiene:</label>
                <textarea id="indicios" name="INDICIOS POR LOS QUE SE DETIENE" required></textarea>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="abogado">Abogado:</label>
                        <select id="abogado" name="ABOGADO">
                            <option value="">Seleccionar...</option>
                            <option value="del turno de oficio">Del turno de oficio</option>
                            <option value="de su elección">De su elección</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="comunicarse">Comunicarse con:</label>
                        <input type="text" id="comunicarse" name="COMUNICARSE CON:">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="otrosDerechos">Otros Derechos:</label>
                        <input type="text" id="otrosDerechos" name="OTROS DERECHOS:">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="seEnviaA">Se Envía a:</label>
                        <select id="seEnviaA" name="SE ENVÍA A:">
                            <option value="">Seleccionar...</option>
                            <option value="S.C.">S.C.</option>
                            <option value="Juzgado">Juzgado</option>
                            <option value="Fiscalía">Fiscalía</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit">📁 Generar Documentos</button>
        </form>

        <div id="message"></div>
    </div>

    <script>
        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${isError ? 'error' : 'success'}`;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Función para generar ODT rellenando placeholders
        async function generarODT(data) {
            try {
                // Cargar la plantilla ODT desde el repo
                const resp = await fetch("plantila_resena.odt");
                if (!resp.ok) throw new Error("No se pudo cargar plantila_resena.odt");
                
                const blob = await resp.arrayBuffer();
                const zip = await JSZip.loadAsync(blob);

                // Leer el content.xml (donde está el texto del documento)
                let contentXml = await zip.file("content.xml").async("string");

                // Reemplazar placeholders {{CAMPO}} por datos
                for (const campo in data) {
                    const valor = data[campo] || "";
                    const regex = new RegExp(`{{${campo}}}`, "g");
                    contentXml = contentXml.replace(regex, valor);
                }

                // Guardar nuevo content.xml al ODT
                zip.file("content.xml", contentXml);

                // Generar nuevo ODT como blob
                const newOdtBlob = await zip.generateAsync({ type: "blob" });
                return newOdtBlob;
                
            } catch (error) {
                console.error("Error generando ODT:", error);
                throw error;
            }
        }

        document.getElementById('registroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                showMessage('⏳ Generando documentos...');
                
                // Crear ZIP principal
                const zip = new JSZip();
                
                // --- GENERAR EXCEL ---
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ['TIPO DOCUMENTO', 'NºDOCUMENTO', 'SEXO', 'Nombre', 'APELLIDOS', 'Nombre de los Padres', 'FECHA DE NACIMIENTO', 'LUGAR DE NACIMIENTO', 'NACIONALIDAD', 'DOMICILIO', 'TELÉFONO', 'DELITO', 'C.P. AGENTES', 'DILIGENCIAS', 'LUGAR DEL HECHO', 'LUGAR DE LA DETENCIÓN', 'HORA DEL HECHO', 'HORA DE LA DETENCIÓN', 'BREVE RESUMEN DE LOS HECHOS', 'INDICIOS POR LOS QUE SE DETIENE', 'ABOGADO', 'COMUNICARSE CON:', 'OTROS DERECHOS:', 'SE ENVÍA A:'],
                    [
                        data['TIPO DOCUMENTO'] || '',
                        data['NºDOCUMENTO'] || '',
                        data['SEXO'] || '',
                        data['Nombre'] || '',
                        data['APELLIDOS'] || '',
                        data['Nombre de los Padres'] || '',
                        data['FECHA DE NACIMIENTO'] || '',
                        data['LUGAR DE NACIMIENTO'] || '',
                        data['NACIONALIDAD'] || '',
                        data['DOMICILIO'] || '',
                        data['TELÉFONO'] || '',
                        data['DELITO'] || '',
                        data['C.P. AGENTES'] || '',
                        data['DILIGENCIAS'] || '',
                        data['LUGAR DEL HECHO'] || '',
                        data['LUGAR DE LA DETENCIÓN'] || '',
                        data['HORA DEL HECHO'] || '',
                        data['HORA DE LA DETENCIÓN'] || '',
                        data['BREVE RESUMEN DE LOS HECHOS'] || '',
                        data['INDICIOS POR LOS QUE SE DETIENE'] || '',
                        data['ABOGADO'] || '',
                        data['COMUNICARSE CON:'] || '',
                        data['OTROS DERECHOS:'] || '',
                        data['SE ENVÍA A:'] || ''
                    ]
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Detenidos');
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                zip.file('DETENIDO.xlsx', excelBuffer);

                // --- GENERAR ODT ---
                try {
                    const odtBlob = await generarODT(data);
                    const odtBuffer = await odtBlob.arrayBuffer();
                    zip.file('DETENIDO.odt', odtBuffer);
                } catch (odtError) {
                    console.warn('Error generando ODT:', odtError);
                    showMessage('⚠️ Excel generado. ODT no disponible (revisa que plantila_resena.odt esté en el repositorio)');
                }

                // Generar y descargar ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, 'DETENIDO.zip');
                
                showMessage('✅ Documentos generados correctamente');
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('❌ Error al generar los documentos', true);
            }
        });
    </script>
</body>
</html>
